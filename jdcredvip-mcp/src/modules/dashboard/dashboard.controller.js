import { getLatestDashboard } from "../metas/metas.service.js";
import { computeDashboardInsights, getResumoDashboard } from "./dashboard.service.js";
import { getDashboardTrend } from "./dashboard.trend.service.js";

const buildFilters = (query) => ({
  promotora: query.promotora,
  produto: query.produto,
  status: query.status,
  dataInicio: query.dataInicio,
  dataFim: query.dataFim
});

const buildSyntheticDashboard = (insights, options = {}) => {
  const resumo = options.resumo;
  const hasMetrics = Boolean(insights?.metrics);

  if (!hasMetrics && !resumo) {
    return null;
  }

  const agora = new Date();
  const isoDate = agora.toISOString();
  const dataReferencia = isoDate.slice(0, 10);

  const metricsSource = hasMetrics
    ? insights.metrics
    : {
        totalContratos: resumo?.contratos ?? 0,
        volumeBruto: resumo?.volume ?? 0,
        volumeLiquido: resumo?.volume ?? 0,
        comissaoTotal: resumo?.comissao ?? 0,
        volumeImportado: null,
        comissaoImportada: null,
        promotorasAtivas: null
      };

  const meta = {
    id: null,
    titulo: "GAIA Snapshot",
    dataReferencia,
    publicadoPor: "GAIA Core",
    metrics: {
      totalContratos: metricsSource.totalContratos,
      volumeBruto: metricsSource.volumeBruto,
      volumeLiquido: metricsSource.volumeLiquido,
      comissaoTotal: metricsSource.comissaoTotal,
      volumeImportado: metricsSource.volumeImportado,
      comissaoImportada: metricsSource.comissaoImportada,
      promotorasAtivas: metricsSource.promotorasAtivas
    },
    metadata: {
      autoGenerated: true,
      generatedAt: isoDate,
      filters: insights?.filters ?? options.filters ?? null,
      source: resumo ? "dashboard-resumo" : "dashboard-insights",
      progresso: resumo?.progresso ?? null,
      mensagem: resumo ? "Sem meta publicada; exibindo dados reais do perÃ­odo." : undefined
    },
    createdAt: isoDate
  };

  const products = hasMetrics
    ? (insights.charts?.porProduto ?? []).map((produto, index) => ({
        id: `synthetic-${index}`,
        metaId: null,
        produto: produto.nome,
        quantidade: produto.totalContratos,
        volumeBruto: produto.volumeBruto ?? produto.volumeLiquido,
        volumeLiquido: produto.volumeLiquido,
        comissao: 0,
        createdAt: isoDate
      }))
    : [];

  return { meta, products };
};

export async function publicado(req, res) {
  try {
    const filters = buildFilters(req.query);
    let dados = await getLatestDashboard();
    if (!dados) {
      const resumo = await getResumoDashboard(filters);
      dados = buildSyntheticDashboard(null, { resumo, filters });

      if (!dados) {
        const insights = await computeDashboardInsights(filters);
        dados = buildSyntheticDashboard(insights, { filters });
      }
    }

    res.json({ status: "ok", dados: dados ?? null });
  } catch (error) {
    console.error("Erro ao carregar dashboard:", error);
    res.status(500).json({
      status: "erro",
      mensagem: "Falha ao acessar os dados do dashboard."
    });
  }
}

export async function resumo(req, res) {
  try {
    const insights = await computeDashboardInsights(buildFilters(req.query));
    res.json({ status: "ok", dados: insights });
  } catch (error) {
    console.error("Erro ao gerar resumo do dashboard:", error);
    res.status(500).json({
      status: "erro",
      mensagem: "Falha ao consolidar dados do dashboard."
    });
  }
}

export async function ranking(req, res) {
  try {
    const insights = await computeDashboardInsights(buildFilters(req.query));
    res.json({
      status: "ok",
      dados: {
        metrics: insights.metrics,
        ranking: insights.ranking,
        comissoes: insights.comissoes,
        charts: {
          porPromotora: insights.charts?.porPromotora ?? [],
          porProduto: insights.charts?.porProduto ?? [],
          porStatus: insights.charts?.porStatus ?? [],
          timeline: insights.charts?.timeline ?? []
        },
        importacoes: insights.importacoes
      }
    });
  } catch (error) {
    console.error("Erro ao gerar ranking do dashboard:", error);
    res.status(500).json({
      status: "erro",
      mensagem: "Falha ao calcular ranking do dashboard."
    });
  }
}

export async function trend(req, res) {
  try {
    const dados = await getDashboardTrend(buildFilters(req.query));
    res.json({ status: "ok", dados });
  } catch (error) {
    console.error("Erro ao gerar tendencia do dashboard:", error);
    res.status(500).json({
      status: "erro",
      mensagem: "Falha ao consolidar tendencia do dashboard."
    });
  }
}
